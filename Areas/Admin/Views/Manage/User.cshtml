@model AirBB.Models.Client
@{
    ViewBag.Title = "User Management";
    var users = ViewBag.Users as List<AirBB.Models.Client> ?? new List<AirBB.Models.Client>();
}

@section scripts {
    <script src="~/lib/jquery-validation/dist/jquery.validate.min.js"></script>
    <script src="~/lib/jquery-validation-unobtrusive/jquery.validate.unobtrusive.min.js"></script>
    <script src="~/js/contact-validation.js"></script>
    <script src="~/js/user-management.js"></script>
}

<div class="container-fluid">
    <h2>User Management</h2>
    
    <!-- Tab Navigation -->
    <ul class="nav nav-tabs" id="userTabs" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="add-user-tab" data-bs-toggle="tab" data-bs-target="#add-user" type="button" role="tab">
                Add New User
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="list-users-tab" data-bs-toggle="tab" data-bs-target="#list-users" type="button" role="tab">
                All Users
            </button>
        </li>
    </ul>

    <!-- Tab Content -->
    <div class="tab-content" id="userTabContent">
        <!-- Add User Tab -->
        <div class="tab-pane fade show active" id="add-user" role="tabpanel">
            <div class="card mt-3">
                <div class="card-body">
                    <!-- ADDED: Model-level validation summary -->
                    @if (!ViewData.ModelState.IsValid)
                    {
                        <div class="alert alert-danger">
                            <strong>Please fix the errors below:</strong>
                        </div>
                    }
                    
                    <div asp-validation-summary="ModelOnly" class="text-danger mb-3"></div>

                    <form id="user-form" asp-action="User" method="post" class="admin-form">
                        <input type="hidden" id="ClientID" name="ClientID" value="0" />
                        <input type="hidden" id="IsEdit" name="IsEdit" value="false" />
                        
                        <div class="row mb-2">
                            <label asp-for="Name" class="col-form-label col-md-2"></label>
                            <div class="col-md-4">
                                <input asp-for="Name" class="form-control" />
                            </div>
                            <div class="col">
                                <span asp-validation-for="Name" class="text-danger"></span>
                            </div>
                        </div>
                        <div class="row mb-2">
                            <label asp-for="PhoneNumber" class="col-form-label col-md-2"></label>
                            <div class="col-md-4">
                                <input asp-for="PhoneNumber" class="form-control" placeholder="(555) 123-4567" />
                                <small class="form-text text-muted">Either phone number or email is required</small>
                            </div>
                            <div class="col">
                                <span asp-validation-for="PhoneNumber" class="text-danger"></span>
                            </div>
                        </div>
                        <div class="row mb-2">
                            <label asp-for="Email" class="col-form-label col-md-2"></label>
                            <div class="col-md-4">
                                <input asp-for="Email" class="form-control" type="email" placeholder="user@example.com" />
                                <small class="form-text text-muted">Either phone number or email is required</small>
                            </div>
                            <div class="col">
                                <span asp-validation-for="Email" class="text-danger"></span>
                            </div>
                        </div>
                        <div class="row mb-2">
                            <label asp-for="SSN" class="col-form-label col-md-2"></label>
                            <div class="col-md-4">
                                <input asp-for="SSN" class="form-control" placeholder="123-45-6789" />
                            </div>
                            <div class="col">
                                <span asp-validation-for="SSN" class="text-danger"></span>
                            </div>
                        </div>
                        <div class="row mb-2">
                            <label asp-for="UserType" class="col-form-label col-md-2"></label>
                            <div class="col-md-4">
                                <select asp-for="UserType" class="form-control">
                                    <option value="">-- Select User Type --</option>
                                    @foreach (var option in AirBB.Models.Client.UserTypeOptions)
                                    {
                                        <option value="@option.Key">@option.Value</option>
                                    }
                                </select>
                            </div>
                            <div class="col">
                                <span asp-validation-for="UserType" class="text-danger"></span>
                            </div>
                        </div>
                        <div class="row mb-2">
                            <label asp-for="DOB" class="col-form-label col-md-2"></label>
                            <div class="col-md-4">
                                <input asp-for="DOB" class="form-control" type="date" max="@DateTime.Today.ToString("yyyy-MM-dd")" />
                            </div>
                            <div class="col">
                                <span asp-validation-for="DOB" class="text-danger"></span>
                            </div>
                        </div>
                        <div class="row">
                            <div class="offset-md-2 col">
                                <button type="submit" class="btn btn-primary admin-btn" id="submit-btn">Add User</button>
                                <button type="button" class="btn btn-secondary admin-btn" id="cancel-btn" style="display:none;">Cancel</button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- List Users Tab -->
        <div class="tab-pane fade" id="list-users" role="tabpanel">
            <div class="card mt-3">
                <div class="card-body">
                    <h5 class="card-title">All Users</h5>
                    
                    <!-- Alert for deletion warnings -->
                    <div id="deletion-alert" class="alert alert-warning" style="display:none;">
                        <strong>Warning:</strong> <span id="deletion-message"></span>
                    </div>
                    
                    <div class="table-responsive">
                        <table class="table table-striped table-hover">
                            <thead class="table-dark">
                                <tr>
                                    <th>Client ID</th>
                                    <th>Name</th>
                                    <th>Phone Number</th>
                                    <th>Email</th>
                                    <th>SSN</th>
                                    <th>User Type</th>
                                    <th>Date of Birth</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var user in users)
                                {
                                    <tr id="user-row-@user.ClientID">
                                        <td>@user.ClientID</td>
                                        <td>@user.Name</td>
                                        <td>@user.PhoneNumber</td>
                                        <td>@user.Email</td>
                                        <td>@user.SSN</td>
                                        <td>@user.UserType</td>
                                        <td>@user.DOB?.ToString("MM/dd/yyyy")</td>
                                        <td>
                                            <button class="btn btn-sm btn-warning edit-btn" data-client-id="@user.ClientID">
                                                <i class="fas fa-edit"></i> Edit
                                            </button>
                                            <button class="btn btn-sm btn-danger delete-btn" data-client-id="@user.ClientID" data-user-type="@user.UserType" data-user-name="@user.Name">
                                                <i class="fas fa-trash"></i> Delete
                                            </button>
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>